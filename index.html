<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Quiz Demo App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Basic Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        #quiz-container {
            background-color: #ffffff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 700px;
            box-sizing: border-box;
            margin-top: 20px;
            text-align: center;
            position: relative; /* For feedback overlay */
            overflow: hidden; /* Contain feedback flash */
        }

        /* Logo */
        #logo {
            max-width: 100px;
            height: auto;
            margin-bottom: 15px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px; /* Increased margin */
            font-size: 1.8em;
            font-weight: 600;
        }

        /* Start Button Styling */
        #start-quiz-btn {
             padding: 15px 35px;
             font-size: 1.2em;
             background-color: #0d6efd;
             color: white;
             border: none;
             border-radius: 8px;
             cursor: pointer;
             transition: background-color 0.2s ease;
             font-weight: 600;
             margin-top: 20px; /* Space below logo/title */
        }
        #start-quiz-btn:hover {
             background-color: #0b5ed7;
        }

        /* Hide quiz content initially */
        #quiz-content {
            display: none;
        }


        /* Header Elements */
        #quiz-header {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            align-items: stretch; /* Make children take full width */
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            gap: 12px;
            text-align: left;
        }

         /* Progress Bar */
        #progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden; /* Ensure inner bar stays contained */
        }
        #progress-bar {
            width: 0%; /* Start at 0 */
            height: 100%;
            background-color: #0d6efd;
            border-radius: 5px;
            transition: width 0.4s ease-in-out;
        }


        #header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }


        #progress-text {
            font-size: 0.95em;
            color: #555;
            font-weight: 500;
        }

        /* Live Counts, Streak & Gifts */
        #live-stats {
            display: flex;
            gap: 10px; /* Space between count groups */
            font-size: 0.9em;
            font-weight: 500;
            flex-wrap: wrap;
            align-items: center; /* Align items vertically */
        }
        #live-counts span, #streak-counter span {
             padding: 3px 6px;
             border-radius: 4px;
        }
        #live-correct-count { background-color: #d1e7dd; color: #0f5132;}
        #live-incorrect-count { background-color: #f8d7da; color: #842029;}
        #streak-counter {
            font-weight: bold;
            color: #ff7b00; /* Orange for streak */
            background-color: #fff3e0;
            display: inline-block; /* Keep it neat */
            visibility: hidden; /* Hide initially */
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
            margin-right: 5px; /* Space before gifts */
        }
        #streak-counter.visible {
            visibility: visible;
            opacity: 1;
        }
        /* Live Gifts Display */
        #live-gifts {
            display: flex;
            gap: 5px;
            font-size: 1.1em; /* Slightly larger icons */
            color: #ff7b00; /* Match streak color */
        }


        #overall-timer {
            font-size: 1.1em;
            color: #e74c3c;
            font-weight: bold;
            background-color: #fbeaea;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap; /* Prevent timer wrapping */
        }

        /* Question Area */
        #question-area {
            margin-bottom: 20px;
            text-align: left;
        }

        #question-text {
            font-size: 1.25em;
            color: #34495e;
            margin-bottom: 20px;
            line-height: 1.5;
            font-weight: 500;
        }

        #options-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            text-align: left;
        }

        /* MCQ Option Styling */
        .mcq-option {
            display: block; width: 100%; padding: 14px 18px; background-color: #f8f9fa;
            border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; text-align: left;
            font-size: 1em; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            box-sizing: border-box; color: #333;
        }
        .mcq-option:hover:not(:disabled) { background-color: #e9ecef; border-color: #adb5bd; transform: translateY(-1px); }
        .mcq-option:disabled { cursor: not-allowed; opacity: 0.7; }
        .mcq-option.selected { background-color: #cfe2ff; border-color: #9ec5fe; font-weight: 600; color: #0a58ca; }

        /* Matching Question Styling */
        .matching-container {
            display: grid; grid-template-columns: auto 1fr; gap: 15px 15px; align-items: center;
            border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #fafafa; text-align: left;
        }
        .match-item-left { padding: 10px; background-color: #e9ecef; border-radius: 6px; text-align: right; font-weight: 500; color: #495057; }
        .match-select { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; width: 100%; box-sizing: border-box; background-color: #fff; font-size: 0.95em; }
        .match-select:disabled { background-color: #e9ecef; cursor: not-allowed; }

        /* Rating Question Styling */
        .rating-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
        .rating-container label { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px 10px; min-width: 45px; border-radius: 6px; transition: background-color 0.2s ease; }
        .rating-container label:hover { background-color: #e9ecef; }
        .rating-container input[type="radio"] { margin-top: 8px; cursor: pointer; transform: scale(1.2); }
        .rating-container input[type="radio"]:disabled { cursor: not-allowed; }
        .rating-container span { font-weight: 500; color: #495057; }

        /* Feedback Styling & Flash Effect */
        #feedback-area {
            margin-top: 20px; font-weight: 600; font-size: 1.1em; min-height: 1.5em;
            text-align: center; padding: 10px; border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for text */
        }
        .feedback-correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback-incorrect { background-color: #f8d7da; color: #842029; }
        .feedback-submitted { background-color: #cfe2ff; color: #0a58ca; }

        /* Flash effect overlay */
        .feedback-flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            pointer-events: none; /* Allow clicks through */
            z-index: 10;
            animation: none; /* Reset animation */
        }
        .feedback-flash.correct-flash { animation: flash-green 0.5s ease-out; }
        .feedback-flash.incorrect-flash { animation: flash-red 0.5s ease-out; }

        @keyframes flash-green {
            0% { opacity: 0; background-color: rgba(25, 135, 84, 0.3); }
            50% { opacity: 1; background-color: rgba(25, 135, 84, 0.3); }
            100% { opacity: 0; background-color: rgba(25, 135, 84, 0.3); }
        }
        @keyframes flash-red {
            0% { opacity: 0; background-color: rgba(220, 53, 69, 0.3); }
            50% { opacity: 1; background-color: rgba(220, 53, 69, 0.3); }
            100% { opacity: 0; background-color: rgba(220, 53, 69, 0.3); }
        }


        /* Navigation/Result Styling */
        #navigation { margin-top: 25px; text-align: center; }
        #submit-btn { padding: 12px 30px; font-size: 1.05em; background-color: #198754; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease; font-weight: 500; }
        #submit-btn:disabled { background-color: #adb5bd; cursor: not-allowed; }
        #submit-btn:hover:not(:disabled) { background-color: #157347; }

        #result-area { text-align: center; padding: 30px; border: 1px solid #bcd0f7; border-radius: 12px; background-color: #e7f0fe; margin-top: 30px; }
        #result-area h2 { margin-bottom: 15px; color: #0a58ca; font-size: 1.6em; }
        #result-area p { font-size: 1.25em; color: #333; margin-bottom: 10px; }
        #result-summary { margin-bottom: 15px; /* Reduced margin */ }
        #result-summary span { display: inline-block; margin: 0 15px; font-weight: 500; }
        .correct-count { color: #198754; }
        .incorrect-count { color: #dc3545; }
        /* Style for Time Taken */
        #time-taken-summary {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 20px;
        }

        /* Achievements / Gifts Section */
        #achievements-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }
        #achievements-section h3 {
            font-size: 1.1em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        #achievements-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 1em; /* Base size for text achievements */
            color: #495057;
            display: flex; /* Use flexbox for alignment */
            flex-wrap: wrap; /* Allow wrapping */
            justify-content: center; /* Center items */
            gap: 10px; /* Space between items */
        }
        #achievements-list li { /* Style for text achievements */
            margin-bottom: 5px;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        #achievements-list li.gift-icon { /* Style specifically for gift icons */
            font-size: 1.8em; /* Make icons larger */
            background-color: transparent; /* No background for icons */
            padding: 0 5px; /* Adjust padding */
            color: #ff7b00; /* Example color for gifts */
        }
        #achievements-list li.achievement-text::before {
            content: '🏆 '; /* Emoji prefix for text achievements */
        }


        #restart-btn { padding: 12px 30px; font-size: 1.05em; background-color: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease; font-weight: 500; margin-top: 20px; }
        #restart-btn:hover { background-color: #0b5ed7; }

        /* Collapsible Review Section */
        #review-section { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; text-align: center; }
        #review-toggle-btn { background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95em; margin-bottom: 15px; }
        #review-toggle-btn:hover { background-color: #5a6268; }
        #review-content { display: none; text-align: left; max-height: 300px; overflow-y: auto; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; }
        .review-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }
        .review-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .review-item p { margin: 5px 0; font-size: 1em; color: #495057; }
        .review-item strong { color: #212529; }
        .review-correct-answer { color: #198754; font-weight: bold; }
        .review-user-answer { color: #dc3545; }

        /* Hide elements initially */
        #result-area, #submit-btn, #quiz-content { /* Added #quiz-content */
             display: none;
        }

    </style>
</head>
<body>

    <div id="quiz-container">
        <div id="feedback-flash" class="feedback-flash"></div>

        <img id="logo"
             src="logo.png" alt="Gethsemane Logo" onerror="this.style.display='none'; console.error('Logo image not found at logo.png')"
             >
        <h1>Bible Quiz Demo (Gamified)</h1>

        <button id="start-quiz-btn">Start Quiz Demo</button>

        <div id="quiz-content">
            <div id="quiz-header">
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="header-info">
                    <span id="progress-text">Question 1 / 10</span>
                    <div id="live-stats">
                        <span id="live-correct-count">✔️ 0</span>
                        <span id="live-incorrect-count">❌ 0</span>
                        <span id="streak-counter">🔥 Streak: 0</span>
                        <div id="live-gifts"></div>
                    </div>
                    <span id="overall-timer">Time Left: 30:00</span>
                </div>
            </div>

            <div id="question-area">
                <p id="question-text">Loading question...</p>
            </div>

            <div id="options-area">
                </div>

            <div id="feedback-area">
                </div>

            <div id="navigation">
                <button id="submit-btn">Submit Answer</button>
            </div>
        </div> <div id="result-area">
            <h2>Quiz Demo Complete!</h2>
            <p>Your final score is: <span id="final-score">0</span> / <span id="total-possible-score">0</span></p>
            <div id="result-summary">
                <span class="correct-count">Correct: <span id="correct-answers-count">0</span></span>
                <span class="incorrect-count">Incorrect: <span id="incorrect-answers-count">0</span></span>
            </div>
            <p id="time-taken-summary">Time Taken: <span id="time-taken">--:--</span></p>

            <div id="achievements-section">
                <h3>Achievements / Gifts Earned:</h3>
                <ul id="achievements-list">
                    <li>No gifts earned yet.</li>
                </ul>
            </div>

            <div id="review-section">
                <button id="review-toggle-btn">Review Incorrect Answers</button>
                <div id="review-content">
                    </div>
            </div>

             <button id="restart-btn">Restart Demo</button>
        </div>
    </div>

    <script>
        // --- Bible Quiz Data (Last 10 Questions Only) ---
        const quizData = [
             { id: 91, question: "Paul requests prayer so that he may declare the mystery of the ______ fearlessly.", type: "MCQ", options: ["Truth", "faith", "Christ", "gospel"], answer: "gospel", points: 1 },
             { id: 92, question: "If we don’t grow up into Christ, we remain like ______?", type: "MCQ", options: ["infants", "dead", "not human", "none"], answer: "infants", points: 1 },
             { id: 93, question: "Who famously said 'Growth is the only evidence of life'?", type: "MCQ", options: ["McDonald", "John Henry Newman", "George MacDonald", "C. S. Lewis"], answer: "John Henry Newman", points: 1 },
             { id: 94, question: "God wants us not to ______ unity but to ______ the unity of the Spirit.", type: "MCQ", options: ["create, keep", "break, build", "hold, leave", "seek, find"], answer: "create, keep", points: 1 },
             { id: 95, question: "Being a saint refers to both a______ (in Christ) and a_______ (in living).", type: "MCQ", options: ["position, progress", "need, seeking", "gift, law", "none"], answer: "position, progress", points: 1 },
             { id: 96, question: "Paul calls the people to:", type: "MCQ", options: ["Walk in love", "Walk as children of light", "Walk carefully (as wise)", "all the above"], answer: "all the above", points: 1 },
             { id: 97, question: "What is a key aspect of spiritual warfare according to Ephesians 6?", type: "MCQ", options: ["Exercise", "Understand the battle and the enemy", "Stand firm", "all the above"], answer: "Stand firm", points: 1 },
             { id: 98, question: "We cannot be _______ in our spirituality, as our Christian pilgrimage involves spiritual warfare.", type: "MCQ", options: ["passive", "active", "holy", "unholy"], answer: "passive", points: 1 },
             { id: 100, question: "One of the devil’s tactics might be to make us forget which spiritual reality?", type: "MCQ", options: ["The Spiritual gifts", "We are sinners", "We are seated with Christ in the heavenly realms", "all the above"], answer: "We are seated with Christ in the heavenly realms", points: 1 },
             { id: 101, question: "How helpful was this demo quiz? (1=Not helpful, 5=Very helpful)", type: "Rating", min: 1, max: 5, points: 0 }
        ];


        // --- DOM Elements ---
        const startQuizButton = document.getElementById('start-quiz-btn');
        const quizContentElement = document.getElementById('quiz-content');
        const questionTextElement = document.getElementById('question-text');
        const optionsAreaElement = document.getElementById('options-area');
        const feedbackAreaElement = document.getElementById('feedback-area');
        const submitButton = document.getElementById('submit-btn');
        const resultAreaElement = document.getElementById('result-area');
        const finalScoreElement = document.getElementById('final-score');
        const totalPossibleScoreElement = document.getElementById('total-possible-score');
        const quizContainer = document.getElementById('quiz-container');
        const progressTextElement = document.getElementById('progress-text');
        const progressBarElement = document.getElementById('progress-bar');
        const overallTimerElement = document.getElementById('overall-timer');
        const restartButton = document.getElementById('restart-btn');
        const correctAnswersCountElement = document.getElementById('correct-answers-count');
        const incorrectAnswersCountElement = document.getElementById('incorrect-answers-count');
        const liveCorrectCountElement = document.getElementById('live-correct-count');
        const liveIncorrectCountElement = document.getElementById('live-incorrect-count');
        const streakCounterElement = document.getElementById('streak-counter');
        const feedbackFlashElement = document.getElementById('feedback-flash');
        const reviewSection = document.getElementById('review-section');
        const reviewToggleButton = document.getElementById('review-toggle-btn');
        const reviewContent = document.getElementById('review-content');
        const achievementsListElement = document.getElementById('achievements-list');
        const liveGiftsElement = document.getElementById('live-gifts');
        const timeTakenElement = document.getElementById('time-taken'); // Time taken display


        // --- Quiz State ---
        let currentQuestionIndex = 0;
        let score = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let currentStreak = 0;
        let earnedGifts = [];
        let userAnswers = {};
        let incorrectlyAnsweredQuestions = [];
        let totalPossibleScore = 0;
        let overallTimerInterval;
        let timeLeft = 30 * 60;
        let autoProceedTimeout;
        let quizStartTime; // To record the start time
        let quizEndTime; // To record the end time

        // --- Gamification Settings ---
        const streakThresholds = {
            3: "fas fa-candy-cane",
            5: "fas fa-pencil-alt",
            8: "fas fa-book"
        };

        // --- Sound Effects (Tone.js Synths) ---
        let correctSound, incorrectSound, completeSound, giftSound;
        let isAudioContextStarted = false;

        function defineSynths() {
            if (!correctSound) {
                correctSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
                incorrectSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.05, release: 0.2 } }).toDestination();
                completeSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.5 } }).toDestination();
                giftSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0.1, release: 0.3 } }).toDestination();
                giftSound.volume.value = -6;
                console.log("Synths Defined");
            }
        }

        async function playSound(synth, note, duration) {
            if (!isAudioContextStarted && Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    isAudioContextStarted = true;
                    console.log("Audio Context Started by playSound.");
                    defineSynths();
                } catch (e) {
                    console.error("Error starting Audio Context:", e);
                    return;
                }
            } else if (!isAudioContextStarted && Tone.context.state === 'running') {
                isAudioContextStarted = true;
                 defineSynths();
            }

            if (synth) {
                synth.triggerAttackRelease(note, duration, Tone.now());
            } else {
                console.warn("Synth not ready, attempting to define and play again.");
                defineSynths();
                if(synth) {
                     synth.triggerAttackRelease(note, duration, Tone.now());
                } else {
                    console.error("Synth still not defined after attempting re-initialization.");
                }
            }
        }

         document.body.addEventListener('click', async () => {
            if (!isAudioContextStarted && Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    isAudioContextStarted = true;
                    console.log("Audio Context Started by user interaction.");
                    defineSynths();
                } catch (e) {
                    console.error("Error starting Audio Context:", e);
                }
            } else if (!isAudioContextStarted && Tone.context.state === 'running') {
                 isAudioContextStarted = true;
                 defineSynths();
            } else if (isAudioContextStarted && !correctSound) {
                 defineSynths();
            }
         }, { once: true });


        // --- Functions ---

        function startQuizFlow() {
             console.log("Starting quiz flow...");
             quizStartTime = Date.now(); // Record start time
             calculateTotalPossibleScore();
             startOverallTimer();
             loadQuestion();
        }


        function startOverallTimer() {
             clearInterval(overallTimerInterval);
             timeLeft = 30 * 60;
             updateTimerDisplay();
             overallTimerInterval = setInterval(() => {
                 timeLeft--;
                 updateTimerDisplay();
                 if (timeLeft <= 0) {
                     clearInterval(overallTimerInterval);
                     clearTimeout(autoProceedTimeout);
                     feedbackAreaElement.textContent = "Time's up!";
                     feedbackAreaElement.className = 'feedback-incorrect';
                     playSound(incorrectSound, "C3", "8n");
                     showResults(); // Show results even if time runs out
                 }
             }, 1000);
         }

        function updateTimerDisplay() { /* ... (no changes) ... */
             const minutes = Math.floor(timeLeft / 60);
             const seconds = timeLeft % 60;
             overallTimerElement.textContent = `Time Left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
         }

        function calculateTotalPossibleScore() { /* ... (no changes) ... */
             totalPossibleScore = quizData.reduce((sum, question) => sum + (question.points || 0), 0);
         }

        function updateLiveCountsAndStreak() { /* ... (no changes) ... */
            liveCorrectCountElement.textContent = `✔️ ${correctCount}`;
            liveIncorrectCountElement.textContent = `❌ ${incorrectCount}`;
            if (currentStreak > 1) {
                streakCounterElement.textContent = `🔥 Streak: ${currentStreak}`;
                streakCounterElement.classList.add('visible');
            } else {
                streakCounterElement.classList.remove('visible');
            }
        }

         function updateProgressBar() { /* ... (no changes) ... */
             const progress = ((currentQuestionIndex) / quizData.length) * 100;
             progressBarElement.style.width = `${progress}%`;
         }

         function displayLiveGifts() { /* ... (no changes) ... */
             liveGiftsElement.innerHTML = '';
             earnedGifts.forEach(giftClass => {
                 const icon = document.createElement('i');
                 icon.className = giftClass;
                 liveGiftsElement.appendChild(icon);
             });
         }

        function proceedToNextQuestion() { /* ... (no changes) ... */
             clearTimeout(autoProceedTimeout);
             currentQuestionIndex++;
             loadQuestion();
         }

        function scheduleAutoProceed() { /* ... (no changes) ... */
             clearTimeout(autoProceedTimeout);
             autoProceedTimeout = setTimeout(proceedToNextQuestion, 2000);
         }

        function triggerFeedbackFlash(isCorrect) { /* ... (no changes) ... */
            feedbackFlashElement.className = 'feedback-flash';
            void feedbackFlashElement.offsetWidth;
            feedbackFlashElement.classList.add(isCorrect ? 'correct-flash' : 'incorrect-flash');
        }


        function loadQuestion() { /* ... (no changes) ... */
            optionsAreaElement.innerHTML = '';
            feedbackAreaElement.textContent = '';
            feedbackAreaElement.className = '';
            userAnswers = {};
            submitButton.style.display = 'none';
            submitButton.disabled = false;

            if (currentQuestionIndex >= quizData.length) {
                showResults();
                return;
            }

            updateProgressBar();
            progressTextElement.textContent = `Question ${currentQuestionIndex + 1} / ${quizData.length}`;
            updateLiveCountsAndStreak();
            displayLiveGifts();

            const currentQuestion = quizData[currentQuestionIndex];
            questionTextElement.textContent = currentQuestion.question;

            switch (currentQuestion.type) {
                case "MCQ": loadMCQOptions(currentQuestion); break;
                case "Matching": loadMatchingOptions(currentQuestion); submitButton.style.display = 'inline-block'; break;
                case "Rating": loadRatingOptions(currentQuestion); break;
                default: optionsAreaElement.innerHTML = '<p>Unsupported question type.</p>'; scheduleAutoProceed(); break;
            }
        }

        function loadMCQOptions(question) { /* ... (no changes) ... */
             let regularOptions = [];
             let specialOptions = [];

             question.options.forEach(option => {
                 const lowerCaseOption = option.toLowerCase();
                 if (lowerCaseOption.includes("all the above") || lowerCaseOption.includes("none of the above")) {
                     specialOptions.push(option);
                 } else {
                     regularOptions.push(option);
                 }
             });

             const shuffledRegularOptions = [...regularOptions].sort(() => Math.random() - 0.5);
             const finalOptions = [...shuffledRegularOptions, ...specialOptions];

             finalOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('mcq-option');
                button.onclick = () => handleMCQAnswer(option, question, button);
                optionsAreaElement.appendChild(button);
            });
         }

        function handleMCQAnswer(selectedOption, question, buttonElement) { /* ... (no changes) ... */
            document.querySelectorAll('.mcq-option').forEach(btn => btn.disabled = true);
            buttonElement.classList.add('selected');

            if (selectedOption === question.answer) {
                score += question.points;
                correctCount++;
                currentStreak++;
                feedbackAreaElement.textContent = "Correct!";
                feedbackAreaElement.className = 'feedback-correct';
                playSound(correctSound, "C5", "8n");
                triggerFeedbackFlash(true);
                checkStreakForGift();
            } else {
                incorrectCount++;
                currentStreak = 0;
                feedbackAreaElement.textContent = `Incorrect!`;
                feedbackAreaElement.className = 'feedback-incorrect';
                playSound(incorrectSound, "C3", "8n");
                triggerFeedbackFlash(false);
                incorrectlyAnsweredQuestions.push({
                    questionText: question.question,
                    userAnswer: selectedOption,
                    correctAnswer: question.answer
                });
            }
            updateLiveCountsAndStreak();
            scheduleAutoProceed();
        }

         function checkStreakForGift() { /* ... (no changes) ... */
             const streakLevel = currentStreak;
             if (streakThresholds[streakLevel] && !earnedGifts.includes(streakThresholds[streakLevel])) {
                 const giftClass = streakThresholds[streakLevel];
                 earnedGifts.push(giftClass);
                 console.log(`Gift earned: ${giftClass} for streak ${streakLevel}`);
                 displayLiveGifts();
                 playSound(giftSound, "E5", "16n");
             }
         }


        function loadMatchingOptions(question) { /* ... (no changes) ... */
             const container = document.createElement('div');
             container.classList.add('matching-container');
             const leftItems = question.pairs.map(pair => pair[0]);
             const rightItems = question.pairs.map(pair => pair[1]);
             const shuffledRightItems = [...rightItems].sort(() => Math.random() - 0.5);

             leftItems.forEach((leftItem) => {
                 const leftElement = document.createElement('div');
                 leftElement.textContent = leftItem;
                 leftElement.classList.add('match-item-left');
                 const selectElement = document.createElement('select');
                 selectElement.classList.add('match-select');
                 selectElement.dataset.leftItem = leftItem;
                 const defaultOption = document.createElement('option');
                 defaultOption.value = "";
                 defaultOption.textContent = "Select match...";
                 selectElement.appendChild(defaultOption);
                 shuffledRightItems.forEach(rightItem => {
                     const optionElement = document.createElement('option');
                     optionElement.value = rightItem;
                     optionElement.textContent = rightItem;
                     selectElement.appendChild(optionElement);
                 });
                  selectElement.onchange = (event) => {
                      userAnswers[leftItem] = event.target.value;
                  };
                 container.appendChild(leftElement);
                 container.appendChild(selectElement);
             });
             optionsAreaElement.appendChild(container);
         }

         function handleMatchingSubmit() { /* ... (no changes) ... */
             submitButton.disabled = true;
             const currentQuestion = quizData[currentQuestionIndex];
             let correctMatches = 0;
             let userMatches = {};
             let correctPairs = {};

             currentQuestion.pairs.forEach(pair => {
                 const leftItem = pair[0];
                 const correctAnswer = pair[1];
                 const userAnswer = userAnswers[leftItem];
                 userMatches[leftItem] = userAnswer || "Not Answered";
                 correctPairs[leftItem] = correctAnswer;

                 if (userAnswer && userAnswer === correctAnswer) {
                     correctMatches++;
                 }
             });

             const pointsEarned = correctMatches;
             score += pointsEarned;

             if (correctMatches === currentQuestion.pairs.length) {
                 correctCount++;
                 currentStreak++;
                 feedbackAreaElement.textContent = `Answer Submitted! (${correctMatches}/${currentQuestion.pairs.length} correct)`;
                 feedbackAreaElement.className = 'feedback-correct';
                 playSound(correctSound, "C5", "8n");
                 triggerFeedbackFlash(true);
                 checkStreakForGift();
             } else {
                 incorrectCount++;
                 currentStreak = 0;
                 feedbackAreaElement.textContent = `Answer Submitted! (${correctMatches}/${currentQuestion.pairs.length} correct)`;
                 feedbackAreaElement.className = 'feedback-submitted';
                 playSound(incorrectSound, "C3", "8n");
                 triggerFeedbackFlash(false);
                 incorrectlyAnsweredQuestions.push({
                     questionText: currentQuestion.question,
                     userAnswer: userMatches,
                     correctAnswer: correctPairs,
                     isMatching: true
                 });
             }

             optionsAreaElement.querySelectorAll('.match-select').forEach(sel => sel.disabled = true);
             updateLiveCountsAndStreak();
             scheduleAutoProceed();
         }


        function loadRatingOptions(question) { /* ... (no changes) ... */
             const container = document.createElement('div');
             container.classList.add('rating-container');
             for (let i = question.min; i <= question.max; i++) {
                 const label = document.createElement('label');
                 const radio = document.createElement('input');
                 radio.type = 'radio';
                 radio.name = `rating-${currentQuestionIndex}`;
                 radio.value = i;
                 radio.onclick = () => handleRatingAnswer(i, question.points);
                 const text = document.createElement('span');
                 text.textContent = i;
                 label.appendChild(text);
                 label.appendChild(radio);
                 container.appendChild(label);
             }
             optionsAreaElement.appendChild(container);
         }

        function handleRatingAnswer(selectedValue, points) { /* ... (no changes) ... */
             optionsAreaElement.querySelectorAll('input[type="radio"]').forEach(rb => {
                 rb.disabled = true;
             });
            console.log(`User rated: ${selectedValue}`);
            feedbackAreaElement.textContent = `Rating Submitted: ${selectedValue}`;
            feedbackAreaElement.className = 'feedback-submitted';
            currentStreak = 0;
            updateLiveCountsAndStreak();
            scheduleAutoProceed();
        }


        // Updated to calculate and display time taken
        function showResults() {
            quizEndTime = Date.now(); // Record end time
            clearInterval(overallTimerInterval);
            clearTimeout(autoProceedTimeout);

            quizContentElement.style.display = 'none';

            finalScoreElement.textContent = score;
            totalPossibleScoreElement.textContent = totalPossibleScore;
            correctAnswersCountElement.textContent = correctCount;
            incorrectAnswersCountElement.textContent = incorrectCount;

            // Calculate and display time taken
            const durationMs = quizEndTime - quizStartTime;
            const durationSeconds = Math.floor(durationMs / 1000);
            const minutesTaken = Math.floor(durationSeconds / 60);
            const secondsTaken = durationSeconds % 60;
            timeTakenElement.textContent = `${minutesTaken}:${secondsTaken < 10 ? '0' : ''}${secondsTaken}`;


            populateAchievements();
            achievementsListElement.parentElement.style.display = 'block';

            populateReviewSection();
            reviewSection.style.display = incorrectlyAnsweredQuestions.length > 0 ? 'block' : 'none';

            resultAreaElement.style.display = 'block';
            playSound(completeSound, "G4", "4n");
        }

        function populateAchievements() { /* ... (no changes) ... */
            achievementsListElement.innerHTML = '';
            let giftsDisplayed = false;

            if (earnedGifts.length > 0) {
                 earnedGifts.forEach(giftClass => {
                    const li = document.createElement('li');
                    li.classList.add('gift-icon');
                    const icon = document.createElement('i');
                    icon.className = giftClass;
                    li.appendChild(icon);
                    achievementsListElement.appendChild(li);
                    giftsDisplayed = true;
                });
            }

             const scorableQuestions = quizData.filter(q => q.points > 0).length;
             if (correctCount === scorableQuestions && scorableQuestions > 0) {
                 const li = document.createElement('li');
                 li.classList.add('achievement-text');
                 li.textContent = "Perfect Score! ✨";
                 li.style.backgroundColor = "#fff3cd"; li.style.color = "#664d03";
                 achievementsListElement.appendChild(li);
                 giftsDisplayed = true;
             } else if (totalPossibleScore > 0 && score / totalPossibleScore >= 0.7) {
                 const li = document.createElement('li');
                 li.classList.add('achievement-text');
                 li.textContent = "Bible Whiz! 👍";
                 li.style.backgroundColor = "#cfe2ff"; li.style.color = "#0a58ca";
                 achievementsListElement.appendChild(li);
                 giftsDisplayed = true;
             }

             if (!giftsDisplayed) {
                  achievementsListElement.innerHTML = '<li>No special achievements or gifts this time.</li>';
             }
        }


        function populateReviewSection() { /* ... (no changes) ... */
             reviewContent.innerHTML = '';
             if (incorrectlyAnsweredQuestions.length === 0) {
                 reviewContent.innerHTML = '<p>No incorrect answers to review!</p>';
                 return;
             }
             incorrectlyAnsweredQuestions.forEach(item => {
                 const div = document.createElement('div');
                 div.classList.add('review-item');
                 const qText = document.createElement('p');
                 qText.innerHTML = `<strong>Q:</strong> ${item.questionText}`;
                 div.appendChild(qText);
                 if (item.isMatching) {
                     const userAnsText = document.createElement('p');
                     userAnsText.innerHTML = `<strong>Your Matches:</strong>`;
                     div.appendChild(userAnsText);
                     const userList = document.createElement('ul');
                     userList.style.listStyle = 'none'; userList.style.paddingLeft = '15px';
                      for (const left in item.userAnswer) {
                          const li = document.createElement('li');
                          li.innerHTML = `${left} &rarr; <span class="review-user-answer">${item.userAnswer[left]}</span>`;
                          userList.appendChild(li);
                      }
                      div.appendChild(userList);
                     const correctAnsText = document.createElement('p');
                     correctAnsText.innerHTML = `<strong>Correct Matches:</strong>`;
                      div.appendChild(correctAnsText);
                      const correctList = document.createElement('ul');
                      correctList.style.listStyle = 'none'; correctList.style.paddingLeft = '15px';
                      for (const left in item.correctAnswer) {
                          const li = document.createElement('li');
                          li.innerHTML = `${left} &rarr; <span class="review-correct-answer">${item.correctAnswer[left]}</span>`;
                          correctList.appendChild(li);
                      }
                      div.appendChild(correctList);
                 } else {
                     const userAnsText = document.createElement('p');
                     userAnsText.innerHTML = `<strong>Your Answer:</strong> <span class="review-user-answer">${item.userAnswer}</span>`;
                     div.appendChild(userAnsText);
                     const correctAnsText = document.createElement('p');
                     correctAnsText.innerHTML = `<strong>Correct Answer:</strong> <span class="review-correct-answer">${item.correctAnswer}</span>`;
                     div.appendChild(correctAnsText);
                 }
                 reviewContent.appendChild(div);
             });
         }

        function toggleReview() { /* ... (no changes) ... */
             if (reviewContent.style.display === 'none' || reviewContent.style.display === '') {
                 reviewContent.style.display = 'block';
                 reviewToggleButton.textContent = 'Hide Review';
             } else {
                 reviewContent.style.display = 'none';
                 reviewToggleButton.textContent = 'Review Incorrect Answers';
             }
         }


        function restartQuiz() { /* ... (no changes) ... */
             currentQuestionIndex = 0;
             score = 0;
             correctCount = 0;
             incorrectCount = 0;
             currentStreak = 0;
             earnedGifts = [];
             userAnswers = {};
             incorrectlyAnsweredQuestions = [];
             clearTimeout(autoProceedTimeout);
             clearInterval(overallTimerInterval);
             quizStartTime = null; // Reset start time
             quizEndTime = null; // Reset end time

             resultAreaElement.style.display = 'none';
             reviewSection.style.display = 'none';
             reviewContent.style.display = 'none';
             reviewToggleButton.textContent = 'Review Incorrect Answers';
             achievementsListElement.parentElement.style.display = 'none';
             liveGiftsElement.innerHTML = '';

             startQuizButton.style.display = 'inline-block';
             quizContentElement.style.display = 'none';

             progressBarElement.style.width = `0%`;

             updateLiveCountsAndStreak();

        }

        // --- Event Listeners ---
         startQuizButton.addEventListener('click', async () => {
             if (!isAudioContextStarted && Tone.context.state !== 'running') {
                 try {
                     await Tone.start();
                     isAudioContextStarted = true;
                     console.log("Audio Context Started by Start Button.");
                     defineSynths(); // Define synths now
                 } catch (e) {
                     console.error("Error starting Audio Context on start button:", e);
                 }
             } else if (!correctSound){
                  defineSynths(); // Define if context was already running
             }

             startQuizButton.style.display = 'none';
             quizContentElement.style.display = 'block';
             startQuizFlow(); // Start quiz logic
         });


         submitButton.addEventListener('click', () => {
            const currentQuestion = quizData[currentQuestionIndex];
            if (currentQuestion.type === "Matching") {
                handleMatchingSubmit();
            }
         });

        restartButton.addEventListener('click', restartQuiz);
        reviewToggleButton.addEventListener('click', toggleReview);


        // --- Initial Setup ---
        // Calculate total score, but don't start quiz yet
        calculateTotalPossibleScore();

    </script>

</body>
</html>
